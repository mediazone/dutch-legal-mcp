name: ğŸš€ Publish to NPM

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor  
          - major

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ§ª Run test suite
        run: npm run validate

      - name: ğŸ“Š Generate coverage
        run: npm run test:coverage

      - name: â˜ï¸ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  publish:
    name: ğŸ“¦ Publish to NPM
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ“ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ”– Bump version (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          git add package.json package-lock.json
          git commit -m "ğŸ”– Bump version to v$NEW_VERSION

          ğŸš€ Automatic version bump via GitHub Actions
          ğŸ“¦ Version type: ${{ github.event.inputs.version_type }}
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git tag "v$NEW_VERSION"
          git push origin main --tags

      - name: ğŸ”– Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "NEW_VERSION=$VERSION" >> $GITHUB_ENV

      - name: ğŸ”– Extract version from release
        if: github.event_name == 'release'
        run: |
          VERSION=${{ github.event.release.tag_name }}
          VERSION=${VERSION#v}
          echo "NEW_VERSION=$VERSION" >> $GITHUB_ENV

      - name: ğŸ“Š Pre-publish validation
        run: |
          echo "ğŸ” Publishing version: $NEW_VERSION"
          echo "ğŸ“¦ Package contents:"
          npm pack --dry-run
          echo "âœ… Package validation complete"

      - name: ğŸ” Check if version exists and auto-bump
        id: version_check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          if npm view @mediazone/dutch-legal-mcp@$CURRENT_VERSION version >/dev/null 2>&1; then
            echo "âŒ Version $CURRENT_VERSION already exists on NPM"
            echo "ğŸ”„ Auto-bumping to patch version..."
            npm version patch --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "âœ… Bumped to version $NEW_VERSION"
            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
            echo "exists=false" >> $GITHUB_OUTPUT
            
            # Commit the version bump
            git add package.json package-lock.json
            git commit -m "ğŸ”– Auto-bump version to v$NEW_VERSION

            ğŸš€ Automatic version bump to avoid NPM conflict
            ğŸ“¦ Previous version $CURRENT_VERSION already published
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git tag "v$NEW_VERSION"
            git push origin main --tags
          else
            echo "âœ… Version $CURRENT_VERSION is available"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ Publish to NPM
        if: steps.version_check.outputs.exists == 'false'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸš€ Publishing @mediazone/dutch-legal-mcp@$NEW_VERSION"
          npm publish --access public
          echo "âœ… Successfully published to NPM!"

      - name: ğŸ“¢ Create GitHub release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v$NEW_VERSION" \
            --title "ğŸ‡³ğŸ‡±âš–ï¸ Dutch Legal MCP v$NEW_VERSION" \
            --notes "## ğŸš€ Release v$NEW_VERSION

          ### âœ¨ What's New
          - Comprehensive test suite (103 tests passing)
          - Professional NPM package with full TypeScript support
          - Meta-compliance GDPR demonstration
          - Enhanced error handling and validation

          ### ğŸ“¦ Installation
          \`\`\`bash
          npm install -g @mediazone/dutch-legal-mcp
          claude mcp add dutch-legal npx -- -y @mediazone/dutch-legal-mcp
          \`\`\`

          ### ğŸ”— Links
          - ğŸ“Š [NPM Package](https://www.npmjs.com/package/@mediazone/dutch-legal-mcp)
          - ğŸŒ [Project Website](https://mediazone.github.io/dutch-legal-mcp)
          - ğŸ“– [Documentation](https://github.com/mediazone/dutch-legal-mcp)

          ### ğŸ§ª Testing
          - âœ… 103/103 tests passing
          - ğŸ“Š 42% code coverage
          - ğŸ›¡ï¸ Security validated
          - ğŸ—ï¸ Production ready

          ---
          ğŸ¤– Auto-generated release via GitHub Actions" \
            --generate-notes

  notify:
    name: ğŸ“¢ Notify Success
    needs: [test, publish]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ğŸ“¢ Success notification
        run: |
          echo "ğŸ‰ Dutch Legal MCP successfully published!"
          echo "ğŸ“¦ Version: ${{ env.NEW_VERSION }}"
          echo "ğŸ”— NPM: https://www.npmjs.com/package/@mediazone/dutch-legal-mcp"
          echo "âœ… All tests passed (103/103)"
          echo "ğŸŒ Ready for Claude Code integration"